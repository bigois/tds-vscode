<!DOCTYPE html>
<html lang="pt-br">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>${d.localize["tds.webview.patch.apply"]}</title>
	<!--Patch Apply-->
</head>
<style>
	${d.css}

    #parent {
      display: table;
      width: 600px;
      height: 300px;
    }
    #child {
        display: table-cell;
        vertical-align: middle;
	}
	#loading {
		z-index: 20;
		position: relative;
		left: 100px;
		top: -515px;
	}
</style>
<!--<link rel="stylesheet" type="text/css" href="../../resources/css/table_materialize.css">-->

<body>
	<div class="mainContainer">
		<div class="formWrap" style="background-image: none;">

			<form name="form_init" id="form_init" onsubmit="save()">

				<div class="logo">
					<span class="formTitle">${d.localize["tds.webview.patch.apply"]}</span>
					<!--Patch Apply-->
				</div>

				<div class="wrap-input">
					<label for="serverName">${d.localize["tds.webview.server.name"]}</label>
					<!--Server Name-->
					<input class="inputText" type="text" id="serverNameID" name="serverName" disabled>
				</div>

				<div class="wrap-input">
					<label for="serverAddress">${d.localize["tds.webview.address"]}</label>
					<!--Address-->
					<input class="inputText" type="text" id="serverAddressID" name="serverAddress" disabled>
				</div>

				<div class="wrap-input">
					<label for="serverEnvironment">${d.localize["tds.webview.environment"]}</label>
					<!--Environment-->
					<input class="inputText" type="text" id="serverEnvironmentID" name="serverEnvironment" disabled>
				</div>

				<div class="wrap-input">
					<label for="patchFile">Patch File</label>
					<br></br>
					<div class="material-table z-depth-3 hoverable">
						<table id="tableInfos" class="mdl-data-table" width="100%">
							<thead>
								<tr class='mdl-data-table__cell--non-numeric'>
									<th>&nbsp</th>
									<th>${d.localize["tds.webview.col03"]}</th>
									<th>${d.localize["tds.webview.col01"]}</th>
									<th>${d.localize["tds.webview.col02"]}</th>
								</tr>
							</thead>
							<tbody>
							</tbody>
						</table>
					</div>
				</div>
				<input class="inputText" type="file" accept='.ptm,.zip,.upd' id="btn-File" name="btn-File"
					onchange="setTextArea(event)" multiple />

				<div class="wrap-output">
					<p id="ApplyOldOutputMessage"></p>
				</div>

				<div class="wrap-input" id="ApplyOldDiv" hidden>
					<label for="ApplyOld">${d.localize["tds.webview.applyOld"]}</label>
					<!--Apply fontes mais antigos -->
					<input class="" type="checkbox" id="ApplyOldID" name="ApplyOld"
						onclick="checkValidations()">
				</div>

				<div class="wrap-output">
					<p id="NewerPatchesOutputMessage"></p>
				</div>

				<div class="wrap-input" id="NewerPatchesDiv" hidden>
					<label for="NewerPatches">${d.localize["tds.webview.newerPatches"]}</label>
					<!--Apply patches desatualizados -->
					<input class="" type="checkbox" id="NewerPatchesID" name="NewerPatches"
						onclick="checkValidations()">
				</div>

				<div class="wrap-output">
					<p id="OutputMessage"></p>
				</div>

				<div class="wrap-submit">
					<input class="btn-submit" readonly style="cursor: pointer;" id="submitID" value="Apply"
						onclick="patchApply(false);" disabled />
				</div>

				<div class="wrap-submit">
					<input class="btn-submit" readonly style="cursor: pointer;" id="submitCloseID" value="Apply/Close"
						onclick="patchApply(true);" disabled />
				</div>

			</form>
		</div>
	</div>
</body>
<script>
	${ d.script }
	const vscode = acquireVsCodeApi();
	var tableAPI = $('#tableInfos').dataTable({
		ordering: false,
		scrollX: true,
		select: true,
		rowReorder: true,
		columnDefs: [
			{
				targets: [1, 2, 3],
				className: 'mdl-data-table__cell--non-numeric tableColor'
			},
			{
				targets: [0],
				className: 'tableColor totvs-col-reorder'
			},
			{
				orderable: true,
				className: 'reorder',
				targets: [1, 2, 3]
			},
			{
				targets: [4],
				visible: false
			}
		],
		dom: 'Bfrtip',
		buttons: [
			{
				text: 'Delete Selected',
				className: "btn-submit",
				exportOptions: {
					modifier: {
						selected: null
					}
				},
				action: function (e, dt, node, config) {
					tableAPI.rows('.selected').remove().draw();
					checkValidations();
				}
			},
			{
				text: 'Patch Validate',
				className: "btn-submit",
				exportOptions: {
					modifier: {
						selected: null
					}
				},
				action: function (e, dt, node, config) {
					var data = tableAPI.row('.selected').data();
					if (data) {
						vscode.postMessage({
							command: 'patchValidateFile',
							file: data[3]
						});
					} else {
						vscode.postMessage({
							command: 'patchValidateFile',
							file: null
						});
					}
				}
			},
			{
				text: 'Patch Info',
				className: "btn-submit",
				exportOptions: {
					modifier: {
						selected: null
					}
				},
				action: function (e, dt, node, config) {
					var data = tableAPI.row('.selected').data();
					if (data) {
						vscode.postMessage({
							command: 'patchInfo',
							file: data[3]
						});
					} else {
						vscode.postMessage({
							command: 'patchInfo',
							file: null
						});
					}
				}
			}
		]
	}).api();

	function patchApply(close) {
		var patchs = tableAPI.data();
		var completePaths = new Array();
		for (var i = 0; i < patchs.length; i++) {
			completePaths.push(patchs[i][3]);
		};

		let applyOld = document.getElementById('ApplyOldID').checked;

		vscode.postMessage({
			command: 'patchApply',
			patchFile: completePaths,
			applyOld: applyOld,
			close: close
		});
	}

	function patchValidate() {
		var patchs = tableAPI.data();
		var completePaths = new Array();
		for (var i = 0; i < patchs.length; i++) {
			if (patchs[i][1] === "Awaiting validation") {
				completePaths.push(patchs[i][3]);
				tableAPI.cell(i,1).data("Validating");
				tableAPI.draw();
			}
		};

		vscode.postMessage({
			command: 'patchValidate',
			patchFiles: completePaths,
		});
		checkValidations();
	}

	window.addEventListener('message', event => {
		const message = event.data; // The JSON data our extension sent
		//console.log("formApplyPatch receive: " + message.command);
		switch (message.command) {
			case 'setCurrentServer':
				const server = message.serverCurrent;
				document.getElementById('serverNameID').value = server.name;
				document.getElementById('serverAddressID').value = server.address + ":" + server.port;
				document.getElementById('serverEnvironmentID').value = server.environment
				break;
			case 'patchValidationRet':
				//console.log("patchValidationRet");
				const file = message.file.toLowerCase();
				//console.log("file: "+file);
				var patchs = tableAPI.data();
				for (var i = 0; i < patchs.length; i++) {
					var patchPath = patchs[i][3].replaceAll('\\\\', '/').toLowerCase();
					//console.log("patchPath: "+patchPath);
					if (patchPath === file) {
						var validationMessage = message.message;
						var errorCode = message.errorCode;
						if (errorCode == 5) {
							validationMessage = "Resources in patch older than RPO. Check Output for details.";
						} else if (errorCode == 7) {
							validationMessage = "Patch apply denied. Check Output for details.";
						} else if (errorCode == 8) {
							console.log(validationMessage);
							validationMessage = "Newer patches available. Check Output for details.";
						}
						//console.log("FOUND! "+message.message);
						tableAPI.cell(i,1).data(validationMessage);
						//console.log("FOUND! "+message.errorCode);
						tableAPI.cell(i,4).data(errorCode);
						tableAPI.draw();
					}
				};
				checkValidations();
				break;
		}
	});

	function setTextArea(event) {
		//console.log("setTextArea: "+event);
		const input = event.target;
		const files = input.files;

		for (var i = 0; i < files.length; i++) {
			//console.log("files: "+files[i]);
			addFile(files[i].path);
		}

		document.getElementById('ApplyOldID').checked = false;
		document.getElementById('NewerPatchesID').checked = false;
		patchValidate();

		input.value = '';
	}

	function addFile(filePath) {
		//console.log("addFile");
		const fnProc = function (filename, fullPath) {
			if (!searchPatch(fullPath)) {
				row = new Array('&#8942;', "Awaiting validation", filename, fullPath, -1);
				tableAPI.row.add(row).draw();
			} else {
				vscode.postMessage({
					command: 'showDuplicateWarning',
					filename: filename
				});
			}
		}

		var fullPath = filePath;
		//console.log("fullPath: "+fullPath);
		var filename = getFilename(fullPath);
		//console.log("filename: "+filename);
		var ext = getExtension(filename);
		//console.log("ext: "+ext);

		fnProc(filename, fullPath);
	}

	function getFilename(filePath) {
		return filePath.substring(filePath.lastIndexOf('\\\\') + 1);
	}

	function getExtension(filename) {
		//return filename.substring(filename.length - 3);
		return filename.substring(filename.lastIndexOf('.') + 1);
	}

	function searchPatch(fullPath) {
		var patchs = tableAPI.data();

		for (var i = 0; i < patchs.length; i++) {
			if (patchs[i][3] == fullPath) {
				return true;
			}
		};

		return false;
	}

	function checkValidations() {
		//console.log("checkValidations");
		var validationOk = true;
		var criticalError = false;
		var hasOld = false;
		var newerPatches = false;
		var validationInProgress = false;
		// reset messages and disable submit buttons
		document.getElementById('ApplyOldOutputMessage').innerHTML = "";
		document.getElementById('NewerPatchesOutputMessage').innerHTML = "";
		document.getElementById('ApplyOldDiv').hidden = true;
		document.getElementById('NewerPatchesDiv').hidden = true;
		document.getElementById('OutputMessage').innerHTML = "";
		document.getElementById('submitID').setAttribute("disabled","disabled");
		document.getElementById('submitCloseID').setAttribute("disabled","disabled");
		var patchs = tableAPI.data();
		if (patchs.length == 0) {
			return; // no action without patches
		}
		for (var i = 0; i < patchs.length; i++) {
			var errorCode = patchs[i][4];
			//console.log("errorCode: "+errorCode);
			if (errorCode < 0) {
				validationInProgress = true;
				break;
			} else if (errorCode > 0) {
				validationOk = false;
				if (!criticalError && ((errorCode >= 1 && errorCode <= 4) || errorCode == 7)) {
					criticalError = true;
				}
				if (!hasOld && errorCode == 5) {
					hasOld = true;
				}
				if (!newerPatches && errorCode == 8) {
					newerPatches = true;
				}
			}
		}
		//console.log("validationInProgress: "+validationInProgress);
		if (!validationInProgress && !criticalError) {
			//console.log("hasOld: "+hasOld);
			if (hasOld) {
				document.getElementById('ApplyOldDiv').hidden = false;
				//console.log("ApplyOldID: "+(document.getElementById('ApplyOldID').checked?"checked":"not checked"));
				document.getElementById('ApplyOldOutputMessage').style = "color: red";
				if (!document.getElementById('ApplyOldID').checked) {
					// warning: has Old resource
					document.getElementById('ApplyOldOutputMessage').innerHTML = "There are patches with sources/resources older than RPO.";
				} else {
					// warning: has Old resource but user choose to overwrite anyway
					document.getElementById('ApplyOldOutputMessage').innerHTML = "This action will overwrite newer sources/resources in the current RPO.";
				}
				validationOk = true;
			}
			//console.log("newerPatches: "+newerPatches);
			if (newerPatches) {
				document.getElementById('NewerPatchesDiv').hidden = false;
				//console.log("NewerPatchesID: "+(document.getElementById('NewerPatchesID').checked?"checked":"not checked"));
				document.getElementById('NewerPatchesOutputMessage').style = "color: red";
				if (!document.getElementById('NewerPatchesID').checked) {
					// warning: has newer patches
					document.getElementById('NewerPatchesOutputMessage').innerHTML = "There are newer patches available at TOTVS Update Center.";
					validationOk = false;
				} else {
					// warning:
					document.getElementById('NewerPatchesOutputMessage').innerHTML = "This action will apply outdated patches.";
					validationOk = true;
				}
			}
		}
		//console.log("validationOk: "+validationOk);
		if (validationInProgress) {
			document.getElementById('OutputMessage').style = "color: blue";
			document.getElementById('OutputMessage').innerHTML = "Patch validation in progress.";
		} else  if (criticalError) {
			document.getElementById('OutputMessage').style = "color: red";
			document.getElementById('OutputMessage').innerHTML = "There are patches that cannot be applied and must be removed from the list.";
		} else {
			if (!validationOk) {
				document.getElementById('OutputMessage').style = "color: red";
				document.getElementById('OutputMessage').innerHTML = "Action required. There are patches with validation problems.";
			} else {
				document.getElementById('submitID').removeAttribute("disabled");
				document.getElementById('submitCloseID').removeAttribute("disabled");
			}
		}
	}
</script>

</html>